generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------
// Platform Admin
// -----------------
model Admin {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  password     String
  refreshToken String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admins")
  @@index([name])
  @@index([createdAt])
  @@index([name, createdAt])
}

// -----------------
// Users (Global Identity)
// -----------------
model User {
  id           String   @id @default(uuid())
  firstName    String
  lastName     String
  email        String   @unique
  password     String?
  refreshToken String?
  isActive     Boolean  @default(false)   // Account active or not
  role         Role?    // KEEP TEMPORARILY FOR SAFE MIGRATION
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  salonUsers        SalonUser[]
  ownerProfile      OwnerProfile?    // Reference to OwnerProfile
  employeeProfile   EmployeeProfile?
  accountantProfile AccountantProfile?

  @@index([email])
}

// -----------------
// Role Enum (Platform / Tenant roles)
// -----------------
enum Role {
  SUPER_ADMIN
  SALON_OWNER
  EMPLOYEE
  ACCOUNTANT
}

// -----------------
// Salon (Tenant)
// -----------------
enum SalonStatus {
  ACTIVE
  TRIAL
  CANCELLED
  LEADS
  EXPIRED
}

enum PlanType {
  BASIC
  PREMIUM
  ENTERPRISE
}

model Salon {
  id            String   @id @default(uuid())
  name          String
  businessType  String
  vtaNumber     String   @unique
  employeeCount Int
  email         String   @unique
  phoneNumber   String

  country       String
  province      String
  city          String
  zipCode       String

  status        SalonStatus @default(TRIAL)
  plan          PlanType    @default(BASIC)
  trialEndsAt   DateTime?
  revenue       Decimal?    @db.Decimal(12,2)
  ltv           Decimal?    @db.Decimal(12,2)
  supportCount  Int         @default(0)
  lastActiveAt  DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  createdBy     String?
  updatedBy     String?

  // Relation to owners (OwnerProfile)
  owners        OwnerProfile[]  // Relation to OwnerProfile

  // Reverse relations for EmployeeProfile and AccountantProfile
  employeeProfiles EmployeeProfile[]
  accountantProfiles AccountantProfile[]

  salonUsers    SalonUser[]

  @@index([status])
  @@index([plan])
  @@index([country])
  @@index([province])
  @@index([city])
  @@index([createdAt])
  @@index([country, province])
}

// -----------------
// Multi-Tenant Bridge: User â†” Salon
// -----------------
model SalonUser {
  id       String @id @default(uuid())
  userId   String
  salonId  String
  role     Role?   // Tenant-scoped role

  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  salon    Salon  @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@unique([userId, salonId])
  @@index([salonId])
  @@index([userId])
  @@index([salonId, role])
}

// -----------------
// Optional Role Profiles (OwnerProfile, EmployeeProfile, AccountantProfile)
// -----------------

// OwnerProfile should reference the User model and the Salon model
model OwnerProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitationSent Boolean  @default(false)
  deletedAt      DateTime?

  salonId        String  // Reference to the salon the owner belongs to
  salon          Salon   @relation(fields: [salonId], references: [id], onDelete: Cascade) // Reverse relation to Salon
}

model EmployeeProfile {
  id          String  @id @default(uuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  salary      Decimal? @db.Decimal(10,2)
  designation String?
  deletedAt   DateTime?

  salonId     String  // The Salon ID this EmployeeProfile belongs to
  salon       Salon   @relation(fields: [salonId], references: [id], onDelete: Cascade)  // Reverse relation to Salon

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AccountantProfile {
  id            String @id @default(uuid())
  userId        String @unique
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  licenseNumber String?
  deletedAt     DateTime?

  salonId       String  // The Salon ID this AccountantProfile belongs to
  salon         Salon   @relation(fields: [salonId], references: [id], onDelete: Cascade)  // Reverse relation to Salon

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
